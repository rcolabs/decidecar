<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DecideCar — RCO Labs</title>
<style>
:root{
 --bg:#0B1220;--card:#0F172A;--text:#E5E7EB;--muted:#9CA3AF;
 --border:rgba(229,231,235,.12);--primaryBg:#E5E7EB;--primaryInk:#111827;
 --compra:#4F8BFF;--assi:#22C55E;
}
[data-theme="light"]{
 --bg:#F6F7F9;--card:#FFFFFF;--text:#1F2937;--muted:#6B7280;
 --border:rgba(17,24,39,.10);--primaryBg:#111827;--primaryInk:#FFFFFF;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,sans-serif;
 background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:560px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:14px}
.btn{width:100%;padding:14px;border-radius:14px;border:none;font-weight:900;
 background:var(--primaryBg);color:var(--primaryInk);cursor:pointer}
.link{background:none;border:none;color:var(--text);text-decoration:underline;font-weight:800;cursor:pointer}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px}
.mode-toggle{display:flex;gap:8px;margin-top:8px}
.mode-toggle button{flex:1;border-radius:999px;border:1px solid var(--border);background:transparent;
 color:var(--muted);font-size:12px;padding:6px 10px;cursor:pointer}
.mode-toggle button.active{background:var(--primaryBg);color:var(--primaryInk)}
.field{margin-bottom:10px}
.field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
.field input{width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--border);
 background:transparent;color:var(--text);font-size:14px}

.with-suffix{position:relative}
.with-suffix input{padding-right:34px}
.suffix{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none}

.field-row{display:flex;gap:8px}
.badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;
 padding:4px 10px;font-size:11px;border:1px solid var(--border);color:var(--muted)}
.result-main{font-size:20px;font-weight:800;margin:8px 0}
.result-sub{font-size:13px;color:var(--muted);margin:2px 0}
.charts{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.chart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.chart-title{font-size:12px;color:var(--muted)}
.chart-legend{display:flex;gap:8px;font-size:11px;color:var(--muted)}
.legend-dot{width:10px;height:10px;border-radius:999px}
.legend-dot.compra{background:var(--compra)}
.legend-dot.assi{background:var(--assi)}
canvas{width:100%;height:180px;display:block;border-radius:10px;background:rgba(15,23,42,.9)}
.note{font-size:11px;color:var(--muted);margin-top:6px}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal-overlay.open{display:flex}
.modal{width:min(720px,100%);max-height:82vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.35)}
.modal header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:16px 16px 10px;border-bottom:1px solid var(--border)}
.modal header h3{margin:0;font-size:16px;letter-spacing:.2px}
.modal header p{margin:4px 0 0;color:var(--muted);font-size:12px;line-height:1.4}
.modal .body{padding:14px 16px 18px;color:var(--text);font-size:14px;line-height:1.55}
.modal .body h4{margin:14px 0 6px;font-size:14px}
.modal .body .kicker{color:var(--muted);font-size:12px;margin-top:-2px}
.modal .close{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
.modal .close:hover{background:rgba(255,255,255,.06)}
[data-theme="light"] .modal-overlay{background:rgba(15,23,42,.35)}

</style>
</head>
<body>
<div class="container">
  <div class="card top">
    <div>
      <strong>DecideCar</strong>
      <button class="link" style="padding:0;font-size:12px" onclick="openModal('rco')">by <span style="text-decoration:underline">RCO Labs</span></button>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
      <button class="link" onclick="toggleTheme()">☀︎ / ☾</button>
      <span id="themeLabel" style="font-size:10px;color:var(--muted)">Dark Lab</span>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 style="margin:0;font-size:18px">Modo de uso</h2>
        <p style="color:var(--muted);font-size:12px;margin:2px 0 0">Rápido para decidir, avançado se quiser ajustar tudo.</p>
      </div>
    </div>
    <div class="mode-toggle">
      <button id="btnModoRapido" class="active" onclick="setModo('rapido')">⚡ Rápido</button>
      <button id="btnModoAvancado" onclick="setModo('avancado')">✦ Avançado</button>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 4px;font-size:18px">Modo rápido</h2>
    <p style="color:var(--muted);font-size:13px;margin:0 0 10px">4 inputs principais. O resto usa premissas padrão.</p>

    <button class="link" onclick="openModal('quick')" style="margin:4px 0 10px;padding:0;text-decoration:none">
      Ver premissas do Modo Rápido →
    </button>
    <p class="note" style="margin-top:-6px">Se alguma premissa não representar seu caso, use o Modo Avançado.</p>

    <div class="field">
      <label for="p">Valor do veículo (R$)</label>
      <input id="p" class="money" data-decimals="0" value="135000" inputmode="decimal"/>
    </div>
    <div class="field">
      <label for="m">Mensalidade da assinatura (R$/mês)</label>
      <input id="m" class="money" data-decimals="0" value="2800" inputmode="decimal"/>
    </div>
    <div class="field-row">
      <div class="field" style="flex:1">
        <label for="prazo">Prazo (meses)</label>
        <input id="prazo" value="24" inputmode="numeric"/>
      </div>
      <div class="field" style="flex:1">
        <label for="rent">Rentabilidade anual do capital (%)</label>
        <div class="with-suffix"><input id="rent" value="12" inputmode="decimal"/><span class="suffix">%</span></div>
      </div>
    </div>
    <div id="advancedFields" style="margin-top:8px;display:none;border-top:1px solid var(--border);padding-top:10px">
      <div class="badge">Modo avançado ativo — todas as premissas contam</div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label for="ipva">IPVA (%/ano)</label>
          <div class="with-suffix"><input id="ipva" value="4" inputmode="decimal"/><span class="suffix">%</span></div>
        </div>
        <div class="field" style="flex:1">
          <label for="seguro">Seguro anual (R$)</label>
          <input id="seguro" class="money" data-decimals="0" value="4000" inputmode="decimal"/>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label for="manut">Manutenção anual (R$)</label>
          <input id="manut" class="money" data-decimals="0" value="1000" inputmode="decimal"/>
        </div>
        <div class="field" style="flex:1">
          <label for="desvAnual">Desvalorização anual (%)</label>
          <div class="with-suffix"><input id="desvAnual" value="10" inputmode="decimal"/><span class="suffix">%</span></div>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label for="desvInicial">Desvalorização ao sair da loja (%)</label>
          <div class="with-suffix"><input id="desvInicial" value="8" inputmode="decimal"/><span class="suffix">%</span></div>
        </div>
        <div class="field" style="flex:1">
          <label for="descontoVenda">Desconto na venda vs FIPE (%)</label>
          <div class="with-suffix"><input id="descontoVenda" value="5" inputmode="decimal"/><span class="suffix">%</span></div>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label for="reajuste">Reajuste anual assinatura (%)</label>
          <div class="with-suffix"><input id="reajuste" value="5" inputmode="decimal"/><span class="suffix">%</span></div>
        </div>
        <div class="field" style="flex:1">
          <label for="extraAnual">Custo extra anual assinatura (R$)</label>
          <input id="extraAnual" class="money" data-decimals="0" value="0" inputmode="decimal"/>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label for="kmContratado">Km/mês contratado</label>
          <input id="kmContratado" value="1000" inputmode="decimal"/>
        </div>
        <div class="field" style="flex:1">
          <label for="kmUsado">Km/mês usado</label>
          <input id="kmUsado" value="1000" inputmode="decimal"/>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="flex:1">
          <label for="custoExcedenteKm">Custo excedente (R$/km)</label>
          <input id="custoExcedenteKm" class="money" data-decimals="2" value="1.5" inputmode="decimal"/>
        </div>
        <div class="field" style="flex:1">
          <label for="taxaAdesao">Taxa de adesão (R$)</label>
          <input id="taxaAdesao" class="money" data-decimals="0" value="0" inputmode="decimal"/>
        </div>
      </div>
      <div class="field">
        <label for="taxaDevolucao">Taxa de devolução (R$)</label>
        <input id="taxaDevolucao" class="money" data-decimals="0" value="0" inputmode="decimal"/>
      </div>
    </div>
    <button class="btn" onclick="calc()">Ver resultado</button>
    <p class="note" id="validationMsg" style="display:none;color:#F97373"></p>
  </div>

  <div class="card" id="r" style="display:none">
    <h3 style="margin:0 0 6px">Resultado</h3>
    <div class="badge" id="badgeVencedor">—</div>
    <div class="result-main" id="resultadoFrase"></div>
    <div class="result-sub" id="resultadoSub"></div>
    <div class="result-sub" id="resultadoDiff"></div>

    <div class="charts">
      <div>
        <div class="chart-head">
          <span class="chart-title">Custo total no prazo</span>
          <div class="chart-legend">
            <span><span class="legend-dot compra"></span> Compra</span>
            <span><span class="legend-dot assi"></span> Assinatura</span>
          </div>
        </div>
        <canvas id="barChart"></canvas>
      </div>
      <div>
        <div class="chart-head">
          <span class="chart-title">Custo acumulado mês a mês</span>
          <div class="chart-legend">
            <span><span class="legend-dot compra"></span> Compra</span>
            <span><span class="legend-dot assi"></span> Assinatura</span>
          </div>
        </div>
        <canvas id="lineChart"></canvas>
      </div>
    </div>

    <button class="link" style="margin-top:10px" onclick="openModal('decidecar')">
      Por trás do DecideCar →
    </button>
    <p class="note">Ferramenta de apoio à decisão. Resultados dependem das premissas.</p>
  </div>
</div>

<!-- Modal: manifestos / por trás -->
<div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <header>
      <div>
        <h3 id="modalTitle">Manifesto</h3>
        <p id="modalSubtitle">RCO Labs</p>
      </div>
      <button class="close" onclick="closeModal()" aria-label="Fechar">✕</button>
    </header>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<script>
let modoAtual = 'rapido';

const MANIFESTO_RCO = `
  <h4>RCO Labs</h4>
  <div class="kicker">Decisão melhor começa com estrutura melhor.</div>
  <p>A RCO Labs nasce de uma inquietação simples: boas decisões seguem sendo tomadas com base em intuição, hábito ou discurso pronto — quando poderiam ser tomadas com clareza, estrutura e números simples.</p>
  <p>Nós não construímos ferramentas para parecer inteligentes. Construímos ferramentas para tornar decisões mais óbvias.</p>
  <p><strong>Acreditamos que:</strong></p>
  <ul>
    <li>complexidade deve ficar no bastidor,</li>
    <li>a interface deve ser simples,</li>
    <li>e o resultado precisa orientar uma escolha real.</li>
  </ul>
  <p>RCO Labs é um laboratório de produtos práticos, criados para pessoas que precisam decidir hoje — não para apresentações bonitas amanhã.</p>
  <p><strong>Menos achismo.</strong> Mais critério. Mais decisão.</p>
`;

const MANIFESTO_DECIDECAR = `
  <h4>DecideCar</h4>
  <div class="kicker">Decidir carro não deveria ser confuso.</div>
  <p>Comprar ou assinar um carro virou um debate raso. De um lado, quem defende posse. Do outro, quem vende conveniência.</p>
  <p>O DecideCar não escolhe lados. Ele organiza os números.</p>
  <p>Aqui, a decisão não vem de opinião, discurso ou “sensação”. Vem do custo real — mensal, anual e no prazo total — considerando o que mais pesa e quase nunca é comparado: o custo do dinheiro, o tempo e a desvalorização.</p>
  <p>O DecideCar existe para responder uma única pergunta:</p>
  <p><strong>Qual opção custa menos no seu perfil?</strong></p>
  <p>Sem cadastro. Sem anúncio. Sem viés.<br/>Só números claros para uma decisão melhor.</p>
`;

const PREMISSAS_RAPIDO = `
  <h4>Premissas do Modo Rápido</h4>
  <div class="kicker">O cálculo usa padrões para reduzir atrito. Se quiser ajustar tudo, use o Modo Avançado.</div>
  <ul style="margin:10px 0 0 18px;line-height:1.6">
    <li><strong>IPVA:</strong> 4% ao ano</li>
    <li><strong>Seguro anual:</strong> R$ 4.000</li>
    <li><strong>Manutenção anual:</strong> R$ 1.000</li>
    <li><strong>Desvalorização anual:</strong> 10%</li>
    <li><strong>Desvalorização ao sair da loja:</strong> 10%</li>
    <li><strong>Reajuste anual da assinatura:</strong> 5%</li>
    <li><strong>Custo excedente (R$/km):</strong> 1,00</li>
  </ul>
  <p style="margin-top:12px;color:var(--muted);font-size:13px">
    Dica: se você já sabe o valor real do seu seguro, IPVA ou manutenção, o Modo Avançado é o lugar certo para ajustar e confirmar a decisão.
  </p>
`;


function openModal(which){
  const overlay = document.getElementById('modalOverlay');
  const title = document.getElementById('modalTitle');
  const subtitle = document.getElementById('modalSubtitle');
  const body = document.getElementById('modalBody');

  if(which === 'quick'){
    title.textContent = 'Modo Rápido';
    subtitle.textContent = 'Premissas do comparativo';
    body.innerHTML = PREMISSAS_RAPIDO;
  } else if(which === 'rco'){
    title.textContent = 'Manifesto';
    subtitle.textContent = 'RCO Labs';
    body.innerHTML = MANIFESTO_RCO;
  } else {
    title.textContent = 'Por trás do DecideCar';
    subtitle.textContent = 'Manifesto do produto';
    body.innerHTML = MANIFESTO_DECIDECAR;
  }

  overlay.classList.add('open');
  overlay.setAttribute('aria-hidden','false');
}

function closeModal(){
  const overlay = document.getElementById('modalOverlay');
  overlay.classList.remove('open');
  overlay.setAttribute('aria-hidden','true');
}

// Close on overlay click / ESC
document.addEventListener('click', (e)=>{
  const overlay = document.getElementById('modalOverlay');
  if(!overlay.classList.contains('open')) return;
  if(e.target === overlay) closeModal();
});
document.addEventListener('keydown',(e)=>{
  if(e.key === 'Escape') closeModal();
});


/** =========================
 *  Currency input formatting
 *  ========================= */
function getMoneyFormatter(decimals){
  return new Intl.NumberFormat('pt-BR',{
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
}
function normalizeMoneyString(v){
  // keep digits, dots, commas, minus
  return String(v ?? '').replace(/[^\d.,-]/g,'');
}
function parseLocalizedNumber(v){
  if(!v) return 0;
  const s = normalizeMoneyString(v).replace(/\./g,'').replace(',','.');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function formatMoneyValue(n, decimals){
  if(!isFinite(n)) n = 0;
  return getMoneyFormatter(decimals).format(n);
}
function formatMoneyInput(el){
  const decimals = parseInt(el.dataset.decimals || '0', 10);
  const n = parseLocalizedNumber(el.value);
  el.value = formatMoneyValue(n, decimals);
}
function initMoneyInputs(){
  const inputs = document.querySelectorAll('input.money');
  inputs.forEach(el=>{
    // initial format
    formatMoneyInput(el);

    // on blur, pretty format
    el.addEventListener('blur', ()=>formatMoneyInput(el));

    // on focus, select all (easier to overwrite on mobile)
    el.addEventListener('focus', ()=>{ try{ el.select(); }catch(e){} });

    // optional: keep only valid chars while typing
    el.addEventListener('input', ()=>{
      const cur = el.value;
      const cleaned = normalizeMoneyString(cur);
      if(cur !== cleaned) el.value = cleaned;
    });
  });
}
document.addEventListener('DOMContentLoaded', initMoneyInputs);

function toggleTheme(){
  const html = document.documentElement;
  const current = html.dataset.theme === 'light' ? 'light' : 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  document.getElementById('themeLabel').textContent =
    next === 'dark' ? 'Dark Lab' : 'Clear Lab';
  try{ localStorage.setItem('decidecar-theme', next); }catch(e){}
}
(function restoreTheme(){
  try{
    const saved = localStorage.getItem('decidecar-theme');
    if(saved === 'light' || saved === 'dark'){
      document.documentElement.dataset.theme = saved;
      const lab = saved === 'dark' ? 'Dark Lab' : 'Clear Lab';
      const el = document.getElementById('themeLabel');
      if(el) el.textContent = lab;
    }
  }catch(e){}
})();

function setModo(modo){
  if(modo === modoAtual) return;
  modoAtual = modo;
  document.getElementById('btnModoRapido').classList.toggle('active', modo==='rapido');
  document.getElementById('btnModoAvancado').classList.toggle('active', modo==='avancado');
  document.getElementById('advancedFields').style.display = modo==='avancado' ? 'block' : 'none';
}

function parseBRL(v){
  if(!v) return 0;
  const s = String(v).replace(/[^\d,-]/g,'').replace(/\./g,'').replace(',','.');
  const n = parseFloat(s);
  return isNaN(n)?0:n;
}
function parsePct(v){
  if(!v) return 0;
  const s = String(v).replace(/[^\d,-]/g,'').replace(',','.');
  const n = parseFloat(s);
  return isNaN(n)?0:n;
}
function formatBRL(n){
  if(!isFinite(n)) return 'R$ 0';
  const r = Math.round(n);
  return 'R$ ' + r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}

function validateInputs(){
  const msgEl = document.getElementById('validationMsg');
  msgEl.style.display = 'none';
  msgEl.textContent = '';
  const p = parseBRL(document.getElementById('p').value);
  const m = parseBRL(document.getElementById('m').value);
  const prazo = parseInt(document.getElementById('prazo').value,10);
  const rent = parsePct(document.getElementById('rent').value);
  if(!p){msgEl.textContent='Preencha o valor do veículo.';msgEl.style.display='block';return false;}
  if(!m){msgEl.textContent='Preencha a mensalidade.';msgEl.style.display='block';return false;}
  if(!prazo || prazo<=0){msgEl.textContent='Preencha o prazo em meses.';msgEl.style.display='block';return false;}
  if(!rent){msgEl.textContent='Preencha a rentabilidade anual do capital.';msgEl.style.display='block';return false;}
  return true;
}

function calc(){
  if(!validateInputs()) return;

  // Ensure visible formatting doesn't break parsing
  // (parseBRL already handles dots/commas)
  const p = parseBRL(document.getElementById('p').value);
  const m = parseBRL(document.getElementById('m').value);
  let prazo = parseInt(document.getElementById('prazo').value,10) || 48;
  let rent = parsePct(document.getElementById('rent').value) || 12;

  let ipva = 4, seguro = 4000, manut = 1000, desvAnual = 10,
      desvInicial = 10, descontoVenda = 10, reajuste = 5, extraAnual = 0,
      kmContratado = 0, kmUsado = 0, custoExcedenteKm = 0, taxaAdesao = 0, taxaDevolucao = 0;

  if(modoAtual === 'avancado'){
    ipva           = parsePct(document.getElementById('ipva').value) || 4;
    seguro         = parseBRL(document.getElementById('seguro').value) || 4000;
    manut          = parseBRL(document.getElementById('manut').value) || 1000;
    desvAnual      = parsePct(document.getElementById('desvAnual').value) || 10;
    desvInicial    = parsePct(document.getElementById('desvInicial').value) || 10;
    descontoVenda  = parsePct(document.getElementById('descontoVenda').value) || 10;
    reajuste       = parsePct(document.getElementById('reajuste').value) || 5;
    extraAnual     = parseBRL(document.getElementById('extraAnual').value) || 0;
    kmContratado   = parseBRL(document.getElementById('kmContratado').value) || 1000;
    kmUsado        = parseBRL(document.getElementById('kmUsado').value) || 1000;
    custoExcedenteKm = parseBRL(document.getElementById('custoExcedenteKm').value) || 1;
    taxaAdesao     = parseBRL(document.getElementById('taxaAdesao').value) || 0;
    taxaDevolucao  = parseBRL(document.getElementById('taxaDevolucao').value) || 0;
  }

  const anos = prazo / 12;
  const ipvaTotal = p * (ipva/100) * anos;
  const seguroTotal = seguro * anos;
  const manutTotal = manut * anos;

  let revenda = p * Math.pow(1 - (desvAnual/100), anos);
  if(desvInicial>0) revenda *= (1 - desvInicial/100);
  if(descontoVenda>0) revenda *= (1 - descontoVenda/100);

  const fator = Math.pow(1 + (rent/100), anos);
  const ganhoPotencial = p * (fator - 1);

  const desval = p - revenda;
  const recorr = ipvaTotal + seguroTotal + manutTotal;
  const custoCompraTotal = recorr + desval + ganhoPotencial;

  let mensTotal = 0;
  const anosCheios = Math.floor(prazo/12);
  const mesesRest = prazo % 12;
  for(let k=0;k<anosCheios;k++){
    mensTotal += 12 * m * Math.pow(1 + (reajuste/100), k);
  }
  mensTotal += mesesRest * m * Math.pow(1 + (reajuste/100), anosCheios);

  let custoExcedenteTotal = 0;
  if(kmContratado>0 && kmUsado>0 && custoExcedenteKm>0){
    const excedenteMensal = Math.max(0, kmUsado - kmContratado);
    const excedenteTotal = excedenteMensal * prazo;
    custoExcedenteTotal = excedenteTotal * custoExcedenteKm;
  }

  const extraTotal = extraAnual * anos;
  let custoAssTotal = mensTotal + custoExcedenteTotal + extraTotal + taxaAdesao + taxaDevolucao - ganhoPotencial;
  if(custoAssTotal<0) custoAssTotal = 0;

  const mensalCompra = custoCompraTotal / prazo;
  const mensalAss = custoAssTotal / prazo;
  const diffTotal = Math.abs(custoCompraTotal - custoAssTotal);

  const winner = mensalCompra <= mensalAss ? 'COMPRA' : 'ASSINATURA';
  const winnerMensal = winner === 'COMPRA' ? mensalCompra : mensalAss;
  const otherMensal = winner === 'COMPRA' ? mensalAss : mensalCompra;

  const frase = `No seu perfil, ${winner} vence por ${formatBRL(winnerMensal)} por mês no prazo de ${prazo} meses.`;
  document.getElementById('badgeVencedor').textContent = winner;
  document.getElementById('resultadoFrase').textContent = frase;
  document.getElementById('resultadoSub').textContent =
    `A outra opção ficaria em ${formatBRL(otherMensal)} por mês.`;
  document.getElementById('resultadoDiff').textContent =
    `Diferença total no prazo: ${formatBRL(diffTotal)}.`;

  document.getElementById('r').style.display = 'block';

  drawBarChart(custoCompraTotal, custoAssTotal);
  drawLineChart(prazo, custoCompraTotal, custoAssTotal);
}

function setupHiDPICanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.font = '10px -apple-system, system-ui, sans-serif';
  ctx.textBaseline = 'middle';
  return {ctx,width:rect.width,height:rect.height};
}

function drawBarChart(compraTotal, assinaturaTotal){
  const canvas = document.getElementById('barChart');
  const {ctx,width:w,height:h} = setupHiDPICanvas(canvas);
  ctx.clearRect(0,0,w,h);

  const maxVal = Math.max(compraTotal, assinaturaTotal) || 1;
  const paddingTop = 20, paddingBottom=28, paddingLeft=24, paddingRight=16;
  const chartH = h - paddingTop - paddingBottom;
  const chartW = w - paddingLeft - paddingRight;
  const barW = Math.min(48, chartW/4);

  ctx.fillStyle = 'rgba(229,231,235,0.9)';
  ctx.textAlign = 'left';
  ctx.fillText('Total no prazo', paddingLeft, paddingTop-8);

  const xCompra = paddingLeft + chartW*0.25 - barW/2;
  const xAss = paddingLeft + chartW*0.75 - barW/2;
  const yBase = h - paddingBottom;
  const hCompra = (compraTotal/maxVal)*chartH;
  const hAss = (assinaturaTotal/maxVal)*chartH;

  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--compra').trim() || '#4F8BFF';
  ctx.beginPath();
  ctx.roundRect(xCompra, yBase - hCompra, barW, hCompra, 6);
  ctx.fill();

  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--assi').trim() || '#22C55E';
  ctx.beginPath();
  ctx.roundRect(xAss, yBase - hAss, barW, hAss, 6);
  ctx.fill();

  ctx.fillStyle = 'rgba(248,250,252,0.95)';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';
  const offset = 4;
  ctx.fillText(formatBRL(compraTotal), xCompra+barW/2, yBase-hCompra-offset);
  ctx.fillText(formatBRL(assinaturaTotal), xAss+barW/2, yBase-hAss-offset);

  ctx.textBaseline = 'top';
  ctx.fillStyle = 'rgba(209,213,219,0.9)';
  ctx.fillText('Compra', xCompra+barW/2, yBase+4);
  ctx.fillText('Assinatura', xAss+barW/2, yBase+4);
}

function drawLineChart(prazo, custoCompraTotal, custoAssTotal){
  const canvas = document.getElementById('lineChart');
  const {ctx,width:w,height:h} = setupHiDPICanvas(canvas);
  ctx.clearRect(0,0,w,h);

  const padL=42,padR=14,padT=18,padB=24;
  const cw = w-padL-padR;
  const ch = h-padT-padB;

  const maxVal = Math.max(custoCompraTotal, custoAssTotal) || 1;

  ctx.strokeStyle = 'rgba(148,163,184,0.3)';
  ctx.lineWidth = 1;
  const steps = 4;
  for(let i=0;i<=steps;i++){
    const y = padT + (ch/steps)*i;
    ctx.beginPath();
    ctx.moveTo(padL,y);
    ctx.lineTo(padL+cw,y);
    ctx.stroke();
  }

  ctx.fillStyle = 'rgba(229,231,235,0.9)';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  for(let i=0;i<=steps;i++){
    const y = padT + (ch/steps)*i;
    const val = maxVal - (maxVal/steps)*i;
    ctx.fillText(formatBRL(val), padL-6, y);
  }

  function buildPoints(total,custoTotal){
    const pts=[], step=custoTotal/total;
    let acc=0;
    for(let m=1;m<=total;m++){
      acc+=step;
      pts.push({mes:m,valor:acc});
    }
    return pts;
  }
  const ptsCompra = buildPoints(prazo,custoCompraTotal);
  const ptsAss = buildPoints(prazo,custoAssTotal);

  function plotLine(points,color){
    ctx.beginPath();
    ctx.lineWidth = 1.8;
    ctx.strokeStyle = color;
    points.forEach((p,idx)=>{
      const x = padL + (cw*(p.mes-1))/Math.max(1,(prazo-1));
      const y = padT + ch*(1 - p.valor/maxVal);
      if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  const compraColor = getComputedStyle(document.documentElement).getPropertyValue('--compra').trim() || '#4F8BFF';
  const assiColor = getComputedStyle(document.documentElement).getPropertyValue('--assi').trim() || '#22C55E';
  plotLine(ptsCompra,compraColor);
  plotLine(ptsAss,assiColor);

  ctx.fillStyle = 'rgba(229,231,235,0.9)';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText('Tempo (meses)', padL+cw/2, h-padB+4);
}
</script>
</body>
</html>
